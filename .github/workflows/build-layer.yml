name: Build Snowflake Lambda Layer

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build-layer:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Pull AWS SAM build image
        run: docker pull public.ecr.aws/sam/build-python3.11:latest

      - name: Create workspace dirs
        run: |
          rm -rf layer-build || true
          mkdir -p layer-build/out/python

      - name: Build layer in SAM image (pip install)
        run: |
          docker run --rm -v "${{ github.workspace }}/layer-build/out":/out public.ecr.aws/sam/build-python3.11:latest \
            /bin/bash -lc "python -m pip install --upgrade pip && \
            pip install --no-cache-dir snowflake-connector-python -t /out/python && \
            pip install --no-cache-dir cryptography -t /out/python || true"

      - name: Show top files (diagnostic)
        run: ls -la layer-build/out/python | head -n 50

      - name: Zip layer
        run: |
          cd layer-build/out
          zip -r ../../snowflake_layer.zip python

      - name: Upload artifact (downloadable)
        uses: actions/upload-artifact@v4
        with:
          name: snowflake_layer_zip
          path: snowflake_layer.zip
